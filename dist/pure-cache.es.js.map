{"version":3,"file":"pure-cache.es.js","sources":["../src/constants/events.js","../src/utils/checkInstanceDisposal.js","../src/expirer.js","../src/pure-cache.js"],"sourcesContent":["/**\n * Events list\n */\nexport default {\n  EXPIRY: \"expiry\",\n  ADD: \"add\",\n  GET: \"get\",\n  REMOVE: \"remove\",\n  CLEAR: \"clear\"\n};\n","const checkIfInstanceIsDisposed = instanceDisposed => {\n  if (instanceDisposed) {\n    throw new Error(\n      \"This instance is already disposed. Please create new instance and try again.\"\n    );\n  }\n};\n\nexport default checkIfInstanceIsDisposed;\n","/**\n * Near realtime expiry handler\n *\n * queue Structure:\n *  {\n *    time1: [{key: key1, onExpire: () => {}}, {key: key2, onExpire: () => {}}],\n *    time2: [{key: key3, onExpire: () => {}}]\n *  }\n */\nimport checkIfInstanceIsDisposed from \"./utils/checkInstanceDisposal\";\n\nexport default class Expirer {\n  queue = {};\n\n  /**\n   * Default config\n   * */\n  defaultConfig = {\n    // By default, check for cache expiry every 100 ms\n    // Reducing this value might create performance issues\n    expiryCheckInterval: 100\n  };\n\n  constructor(config = {}) {\n    // Configuration\n    this.config = { ...this.defaultConfig, ...config };\n\n    // Instance dispose status\n    this.instanceDisposed = false;\n\n    // Store last expired time to navigate from current expired time to last expired time\n    // Set initial value to current time - 1\n    // Don't set to 0 as expiry function will loop from current time to 0\n    this.lastExpiredTime = Date.now() - 1;\n\n    // Run the expiry function at every configured interval time\n    const { expiryCheckInterval } = this.config;\n    this.timer = setInterval(this.expire, expiryCheckInterval);\n  }\n\n  /**\n   * Expiry function\n   * */\n  expire = () => {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    const time = Date.now();\n\n    for (let t = time; t >= this.lastExpiredTime; t -= 1) {\n      const toExpire = this.queue[t];\n\n      if (toExpire) {\n        delete this.queue[t];\n        toExpire.forEach(({ key, onExpire }) => onExpire(key));\n      }\n    }\n\n    this.lastExpiredTime = time;\n  };\n\n  /**\n   * Add to expiry queue\n   *\n   * @param {Number} time  When to expire\n   * @param {String} key Cache key\n   * @param {Function} onExpire Expiry callback, called when Date.now() ~= time\n   * */\n  add(time, key, onExpire) {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    if (!this.queue[time]) {\n      this.queue[time] = [];\n    }\n\n    this.queue[time].push({ key, onExpire });\n\n    return true;\n  }\n\n  /**\n   * Remove specific key from expiry queue\n   *\n   * @param {Number} time  Expiry time\n   * @param {String} key Cache key to remove\n   * */\n  remove(time, key) {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    const queue = this.queue[time];\n\n    if (queue) {\n      // Filter out keys in queue[time] which are matching current remove key\n      const filteredQueue = queue.filter(({ key: k }) => k !== key);\n      if (!filteredQueue.length) {\n        delete this.queue[time];\n      } else {\n        this.queue[time] = filteredQueue;\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Cleanup\n   *    - Empty queue\n   *    - Clear expirer timer\n   * */\n  dispose() {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    clearInterval(this.timer);\n    this.timer = null;\n    this.queue = {};\n    this.instanceDisposed = true;\n\n    return true;\n  }\n}\n","/**\n * pure-cache: Cache with confidence ðŸŽ‰ Ultra fast in-memory JavaScript cache with near realtime cache expiry feature âš¡\n *\n * cacheStore Structure:\n *    {\n *      key1: { value: value1, addedAt: 1527012874728, expiryAt: 1527012879729 },\n *      key2: { value: value2, addedAt: 1527012908893, expiryAt: 1527012909880 },\n *      ...\n *    }\n */\nimport mitt from \"mitt\";\nimport Events from \"./constants/events\";\nimport Expirer from \"./expirer\";\nimport checkIfInstanceIsDisposed from \"./utils/checkInstanceDisposal\";\n\nexport default class PureCache {\n  /**\n   * Cache store\n   * */\n  cacheStore = {};\n\n  /**\n   * Default config\n   * */\n  defaultConfig = {\n    // Default cache expiry time, 60000ms(60s) by default\n    // Set `false` to disable expiry(This beats the purpose of cache, the data is store until the instance is disposed)\n    // Note: Falsy values like `0` will be treated as `false`\n    defaultCacheExpiryIn: 60000,\n    // By default, check for cache expiry every 100 ms\n    // Reducing this value might create performance issues\n    expiryCheckInterval: 100\n  };\n\n  constructor(config = {}) {\n    // Configuration\n    this.config = { ...this.defaultConfig, ...config };\n\n    // Event listeners\n    const { on, off, emit } = mitt();\n    [this.on, this.off, this.emit] = [on, off, emit];\n\n    // Instance dispose status\n    this.instanceDisposed = false;\n\n    // Create cache expirer instance, which maintains its own expiry queue\n    const { expiryCheckInterval } = this.config;\n    this.cacheExpirer = new Expirer({ expiryCheckInterval });\n  }\n\n  /**\n   * Put data into cache\n   *\n   * @param {String} key  Cache key\n   * @param {String|Object|*} value Value to be stored against cache key\n   * @param {Number} expiryIn Expiry time for the key, defaults to defaultCacheExpiryIn\n   * */\n  put(key = \"\", value = \"\", expiryIn = this.config.defaultCacheExpiryIn) {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    // Remove existing values in the key(if any)\n    if (this.cacheStore[key]) {\n      this.remove(key);\n    }\n\n    const addedAt = Date.now();\n    // Ignore all falsy values(like `0` & `false`)\n    // Basically if there is no expiry, cache will act as simple in-memory data store\n    const expiryAt = expiryIn ? addedAt + expiryIn : null;\n    const target = { value, addedAt, expiryAt };\n    this.cacheStore[key] = target;\n\n    // If expiry time exists, add to expiry queue\n    if (expiryAt) {\n      // Remove value from cache and trigger expiry event\n      const onExpire = () => {\n        this.emit(Events.EXPIRY, {\n          key,\n          data: target\n        });\n        this.remove(key);\n      };\n\n      this.cacheExpirer.add(expiryAt, key, onExpire);\n    }\n    this.emit(Events.ADD, { key, data: target });\n\n    return target;\n  }\n\n  /**\n   * Get data from cache\n   *\n   * @param {String} key  Cache key\n   *\n   * @returns {Object} Object { value, addedAt, expiryAt }\n   * */\n  get(key = \"\") {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    const target = this.cacheStore[key];\n\n    if (target) {\n      this.emit(Events.GET, { key, data: target });\n      return target;\n    }\n\n    return null;\n  }\n\n  /**\n   * Remove data from cache\n   *\n   * @param {String} key  Cache key to be removed\n   * */\n  remove(key) {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    const target = this.cacheStore[key];\n\n    if (target) {\n      // Remove key & value from cache\n      delete this.cacheStore[key];\n      const { expiryAt } = target;\n      // If timer exists for the key, remove it\n      this.cacheExpirer.remove(expiryAt, key);\n      this.emit(Events.REMOVE, { key, data: target });\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Cleanup\n   *    - Clear entire cache\n   *    - Stop expirer\n   * */\n  dispose() {\n    checkIfInstanceIsDisposed(this.instanceDisposed);\n\n    Object.keys(this.cacheStore).forEach(key => this.remove(key));\n    this.emit(Events.CLEAR, {});\n    this.cacheExpirer.dispose();\n    this.instanceDisposed = true;\n\n    return true;\n  }\n}\n"],"names":["checkIfInstanceIsDisposed","instanceDisposed","Error","Expirer","config","time","Date","now","t","lastExpiredTime","toExpire","queue","forEach","key","onExpire","defaultConfig","expiryCheckInterval","timer","setInterval","expire","push","filteredQueue","filter","k","length","PureCache","mitt","on","off","emit","cacheExpirer","value","expiryIn","defaultCacheExpiryIn","cacheStore","remove","addedAt","expiryAt","target","Events","EXPIRY","add","ADD","GET","REMOVE","keys","CLEAR","dispose"],"mappings":"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"}